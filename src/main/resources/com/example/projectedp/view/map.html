<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ‚ú® Import Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <style>
        /* Map container musi mieƒá wysoko≈õƒá */
        #map { height: 100vh; margin: 0; padding: 0; }
    </style>
    <title></title>
</head>
<body>
    <div id="map"></div>

    <!-- ‚ú® Import Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        var map = L.map('map').setView([52.2297, 21.0122], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);

        var markers = {};

        function addMarker(lat, lon, stopId, stopName, stopNumber) {
            if (markers[stopId]) return;

            var marker = L.marker([lat, lon]).addTo(map);

            var popupContent = `
                <div>
                    <strong>${stopName}</strong><br/>
                    <button onclick="onShowGroupClicked('${stopId}')">üîç Poka≈º s≈Çupki</button>
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.stopId = stopId;

            markers[stopId] = marker;
        }

        function addSubMarker(lat, lon, stopId, stopName, stopNumber) {
            var key = stopId + "_" + stopNumber;

            var subIcon = L.icon({
                iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',
                iconSize: [24, 24],
                iconAnchor: [12, 24],
                popupAnchor: [0, -24]
            });

            var marker = L.marker([lat, lon], { icon: subIcon, opacity: 0.85 }).addTo(map);

            var popupContent = `
                <div>
                    <strong>${stopName} ${stopNumber}</strong><br/>
                    <button onclick="onShowDeparturesClicked('${stopId}', '${stopNumber}', '${key}')">üöå Poka≈º odjazdy</button>
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.stopId = stopId;
            marker.isSubStop = true;

            markers[key] = marker;
        }

        function onShowGroupClicked(stopId) {
            if (window.app && typeof app.onStopGroupClicked === 'function') {
                app.onStopGroupClicked(stopId);
            }
        }

        function onShowDeparturesClicked(stopId, stopNumber, markerKey) {
            // wywo≈Çanie Javy
            if (window.app && typeof app.onSubStopClicked === 'function') {
                app.onSubStopClicked(stopId, stopNumber);
            }

            // pod≈õwietlenie markera
            var marker = markers[markerKey];
            if (marker) {
                marker.setOpacity(1.0);
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();

                // po 3 sekundy przywr√≥cenie przezroczysto≈õci
                setTimeout(() => {
                    marker.setOpacity(0.85);
                }, 3000);
            }
        }


        function clearMarkers() {
            for (var id in markers) {
                map.removeLayer(markers[id]);
            }
            markers = {};
        }

        function clearSubMarkers() {
            for (var id in markers) {
                if (markers[id].isSubStop) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
            }
        }

        function mapLoaded() {
            app.onMapInitialized();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const interval = setInterval(() => {
                if (window.app && typeof app.onMapInitialized === 'function') {
                    clearInterval(interval);
                    app.onMapInitialized();
                }
            }, 100);
        });
    </script>

</body>
</html>